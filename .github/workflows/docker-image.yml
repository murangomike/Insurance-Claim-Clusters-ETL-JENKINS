name: CI Pipeline for Insurance Claim Clustering

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      VENV_DIR: venv

    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸ”§ Install System Packages
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential gcc g++ python3-dev \
          libblas-dev liblapack-dev libatlas-base-dev gfortran

    - name: ğŸ Set Up Python and Virtual Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ› ï¸ Install Python Packages
      run: |
        python -m venv $VENV_DIR
        source $VENV_DIR/bin/activate

        pip install --upgrade pip setuptools wheel
        pip install Flask==2.3.3 Flask-CORS==4.0.0
        pip install --only-binary=all scikit-learn==1.3.0 || pip install scikit-learn==1.3.0

        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: ğŸ” Verify Installation
      run: |
        source $VENV_DIR/bin/activate
        python -c "import flask; print('âœ… Flask:', flask.__version__)"
        python -c "import sklearn; print('âœ… scikit-learn:', sklearn.__version__)"
        python -c "import flask_cors; print('âœ… Flask-CORS imported successfully')"

    - name: ğŸ§ª Run Tests (if available)
      run: |
        source $VENV_DIR/bin/activate
        if [ -d tests ]; then
          pip install pytest
          pytest tests/
        else
          echo "âš ï¸ No 'tests/' directory found. Skipping tests."
        fi

    - name: ğŸš« Skip Running App
      run: |
        echo "âš ï¸ GitHub Actions is not designed to run persistent apps like Flask."
        echo "To run the app, deploy it to a service (Heroku, EC2, Railway, etc.)"
